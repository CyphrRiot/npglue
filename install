#!/bin/bash
# NPGlue - DeepSeek-R1 Installation Script
# Simple, beautiful, and memory-safe installation

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

clear
echo -e "${BLUE}╭─────────────────────────────────────────────╮${NC}"
echo -e "${BLUE}│             🚀 NPGlue Installer             │${NC}"
echo -e "${BLUE}│      DeepSeek-R1 + OpenVINO + Goose        │${NC}"
echo -e "${BLUE}╰─────────────────────────────────────────────╯${NC}"
echo
echo -e "${CYAN}This will install everything you need for local AI coding assistance${NC}"
echo

# System checks
echo -e "${BLUE}📋 Checking system requirements...${NC}"
TOTAL_MEM_GB=$(free -g | awk '/^Mem:/{print $2}')
AVAILABLE_GB=$(df . | awk 'NR==2{printf "%.0f", $4/1024/1024}')

if [ "$TOTAL_MEM_GB" -lt 12 ]; then
    echo -e "${RED}❌ Need at least 12GB RAM (found ${TOTAL_MEM_GB}GB)${NC}"
    exit 1
fi
if [ "$AVAILABLE_GB" -lt 15 ]; then
    echo -e "${RED}❌ Need at least 15GB disk space${NC}"
    exit 1
fi
echo -e "${GREEN}✅ System OK: ${TOTAL_MEM_GB}GB RAM, ${AVAILABLE_GB}GB space${NC}"

# Install system dependencies
echo -e "\n${BLUE}📦 Installing system packages...${NC}"
sudo pacman -S --needed --noconfirm python python-pip base-devel cmake git intel-compute-runtime
echo -e "${GREEN}✅ System packages installed${NC}"

# Create clean Python environment
echo -e "\n${BLUE}🐍 Setting up Python environment...${NC}"
[ -d "openvino-env" ] && rm -rf openvino-env
python -m venv openvino-env
source openvino-env/bin/activate
pip install --upgrade pip wheel

# Install AI packages
echo -e "${BLUE}🤖 Installing AI packages...${NC}"
pip install openvino>=2025.0 optimum-intel transformers torch --index-url https://download.pytorch.org/whl/cpu
pip install fastapi uvicorn psutil huggingface-hub
echo -e "${GREEN}✅ AI packages installed${NC}"

# Download model (safe, no loading)
echo -e "\n${BLUE}📥 Downloading DeepSeek-R1 model...${NC}"
mkdir -p models
if [ -f "models/deepseek-r1-fp16-ov/DeepSeek-R1-0528-Qwen3-8B-fp16-ov/openvino_model.bin" ]; then
    echo -e "${GREEN}✅ Model already downloaded${NC}"
else
    echo -e "${CYAN}Downloading professional FP16 OpenVINO model...${NC}"
    python -c "
from huggingface_hub import snapshot_download
snapshot_download(
    repo_id='Echo9Zulu/DeepSeek-R1-0528-Qwen3-8B-OpenVINO',
    allow_patterns=['DeepSeek-R1-0528-Qwen3-8B-fp16-ov/*'],
    local_dir='models/deepseek-r1-fp16-ov',
    local_dir_use_symlinks=False
)
print('✅ Model downloaded successfully')
"
fi

# Memory-safe verification (no model loading)
echo -e "\n${BLUE}🧪 Verifying installation...${NC}"
python -c "
import openvino
import transformers
print('✅ OpenVINO:', openvino.__version__)
print('✅ Transformers:', transformers.__version__)
print('✅ Available devices:', openvino.Core().available_devices)
print('✅ All packages working correctly')
"

# Create startup script
cat > start_server.sh << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
source openvino-env/bin/activate
python server_production.py
EOF
chmod +x start_server.sh

# CPU optimization
echo -e "\n${BLUE}⚡ Optimizing CPU performance...${NC}"
sudo ./boost_cpu.sh

# Beautiful completion message
clear
echo -e "${GREEN}╭─────────────────────────────────────────────╮${NC}"
echo -e "${GREEN}│           🎉 INSTALLATION COMPLETE!         │${NC}"
echo -e "${GREEN}╰─────────────────────────────────────────────╯${NC}"
echo
echo -e "${BLUE}📋 NPGlue is ready! Here's what to do next:${NC}"
echo
echo -e "${YELLOW}1. Start the AI server:${NC}"
echo -e "   ${CYAN}./start_server.sh${NC}"
echo
echo -e "${YELLOW}2. Update Goose configuration:${NC}"
echo -e "   ${CYAN}cp goose_config_example.yaml ~/.config/goose/config.yaml${NC}"
echo -e "   ${CYAN}# or add to existing config:${NC}"
echo -e "${PURPLE}   provider: openai${NC}"
echo -e "${PURPLE}   model: deepseek-r1-openvino${NC}"
echo -e "${PURPLE}   api_base: http://localhost:8000/v1${NC}"
echo -e "${PURPLE}   api_key: local-key${NC}"
echo
echo -e "${YELLOW}3. Update Zed settings:${NC}"
echo -e "   ${CYAN}# Add to ~/.config/zed/settings.json:${NC}"
echo -e "${PURPLE}   \"assistant\": {${NC}"
echo -e "${PURPLE}     \"version\": \"2\",${NC}"
echo -e "${PURPLE}     \"provider\": {${NC}"
echo -e "${PURPLE}       \"name\": \"openai\",${NC}"
echo -e "${PURPLE}       \"api_url\": \"http://localhost:8000/v1\",${NC}"
echo -e "${PURPLE}       \"api_key\": \"local-key\"${NC}"
echo -e "${PURPLE}     }${NC}"
echo -e "${PURPLE}   }${NC}"
echo
echo -e "${YELLOW}4. Test the installation:${NC}"
echo -e "   ${CYAN}curl http://localhost:8000/health${NC}"
echo -e "   ${CYAN}python test_installation.py${NC}"
echo
echo -e "${GREEN}📊 Performance expectations:${NC}"
echo -e "   • Speed: ${GREEN}15-25+ tokens/sec${NC}"
echo -e "   • Memory: ${GREEN}~10-12GB${NC}"
echo -e "   • Model: ${GREEN}DeepSeek-R1 FP16 (~8GB)${NC}"
echo
echo -e "${BLUE}💡 Tips:${NC}"
echo -e "   • First generation is slower (warmup)"
echo -e "   • Use 'source openvino-env/bin/activate' to activate environment"
echo -e "   • Server runs on http://localhost:8000"
echo
echo -e "${GREEN}✨ Happy coding with your local AI assistant! ✨${NC}"
